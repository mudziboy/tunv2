#!/bin/bash
# ==========================================
# Full Update Script #tunv2 - ZIP Version
# ==========================================

# 1. Validasi Izin Script (Original Logic)
ipsaya=$(wget -qO- ipinfo.io/ip)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")
data_ip="https://raw.githubusercontent.com/mudziboy/regist/main/izin"

checking_sc() {
  useexp=$(wget -qO- $data_ip | grep $ipsaya | awk '{print $3}')
  if [[ $date_list < $useexp ]]; then
    echo -ne
  else
    echo -e "${OR}────────────────────────────────────────────${NC}"
    echo -e "\033[42m          JOYTUNNEL AUTOSCRIPT          ${NC}"
    echo -e "${OR}────────────────────────────────────────────${NC}"
    echo -e ""
    echo -e "            ${RED}PERMISSION DENIED !${NC}"
    echo -e "   \033[0;33mYour VPS${NC} $ipsaya \033[0;33mHas been Banned${NC}"
    echo -e "     \033[0;33mBuy access permissions for scripts${NC}"
    echo -e "             \033[0;33mContact Admin :${NC}"
    echo -e "      ${Green}WhatsApp${NC} wa.me/"
    echo -e "         \033[0;36mTelegram${NC} t.me/6283813204499"
    echo -e "${OR}────────────────────────────────────────────${NC}"
    exit
  fi
}

loading_bar() {
    local total=$1
    local current=0
    local width=50
    local filled="▰"
    local empty="▱"

    while [ "$current" -le "$total" ]; do
        local filled_count=$((current * width / total))
        local empty_count=$((width - filled_count))

        local bar=$(printf "%${filled_count}s" | tr ' ' "$filled")
        bar+=$(printf "%${empty_count}s" | tr ' ' "$empty")

        printf "\r[${bar}] %d%%" $((current * 100 / total))
        sleep 0.1
        ((current++))
    done
    printf "\n"
}

echo "Memulai proses update masal, mohon tunggu..."

# 2. Proses Download dan Ekstrak ZIP (Original Logic)
mkdir -p /etc/menu
cd /etc/menu
url="https://github.com/mudziboy/tunv2/raw/main/ssh/project.zip"

wget -O menu.zip "$url" >/dev/null 2>&1 &
PID=$!
# Panggil loading bar kamu
# loading_bar 100 
wait $PID

7z e -pTunnelftdor menu.zip >/dev/null 2>&1
chmod +x * >/dev/null 2>&1
find . -type f -exec dos2unix {} \; >/dev/null 2>&1

# 3. FIX KHUSUS ZIVPN (Agar tidak error API Key)
# Jika file API key hilang, buat baru otomatis agar apicreate tidak gagal
if [ ! -f "/etc/zivpn/apikey" ]; then
    mkdir -p /etc/zivpn/api
    openssl rand -hex 16 > /etc/zivpn/apikey
    echo "8080" > /etc/zivpn/api_port
fi

# Cek apakah file zivpn-api.go ada di hasil ekstrak ZIP
if [ -f "zivpn-api.go" ]; then
    mv zivpn-api.go /etc/zivpn/api/zivpn-api.go
    cd /etc/zivpn/api
    go build -o zivpn-api zivpn-api.go
    chmod +x zivpn-api
    systemctl restart zivpn-api
    cd /etc/menu
fi

# 4. Pindahkan sisanya ke /usr/bin
mv * /usr/bin >/dev/null 2>&1

# 5. Membersihkan sisa instalasi
cd
rm -rf /etc/menu >/dev/null 2>&1

echo "Update selesai. Seluruh protokol (SSH, Xray, ZiVPN) telah diperbarui."