#!/bin/bash
# ==========================================
# Full Update Script #tunv2 Project - ZIP Version
# ==========================================

# Color definitions
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;39m"

# 1. Validasi Izin Script (Original Logic)
ipsaya=$(wget -qO- ipinfo.io/ip)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")
data_ip="https://raw.githubusercontent.com/mudziboy/regist/main/izin"

# Pengecekan Izin Akses
useexp=$(wget -qO- $data_ip | grep $ipsaya | awk '{print $3}')
if [[ $date_list < $useexp ]]; then
    echo -e "${green}Permission Granted...${neutral}"
else
    echo -e "${red}PERMISSION DENIED! Contact Admin.${neutral}"
    exit 1
fi

echo -e "${blue}Memulai proses update masal, mohon tunggu...${neutral}"

# 2. Instalasi Dependensi yang dibutuhkan
apt update -y && apt install golang dos2unix p7zip-full -y

# 3. Proses Download dan Ekstrak ZIP
mkdir -p /etc/menu
cd /etc/menu
url="https://github.com/mudziboy/tunv2/raw/main/project/project.zip"

wget -O menu.zip "$url"
7z e -pTunnelftdor menu.zip >/dev/null 2>&1

# Fix Format File (Windows to Linux)
find . -type f -exec dos2unix {} \; >/dev/null 2>&1

# 4. Integrasi & Re-Compile ZiVPN API (Otomatis)
if [ -f "zivpn-api.go" ]; then
    echo -e "${green}Re-compiling ZiVPN API...${neutral}"
    mkdir -p /etc/zivpn/api
    mv zivpn-api.go /etc/zivpn/api/zivpn-api.go
    mv go.mod /etc/zivpn/api/go.mod 2>/dev/null
    
    cd /etc/zivpn/api
    rm -f go.mod go.sum zivpn-api
    go mod init zivpn
    go mod tidy
    go build -o zivpn-api zivpn-api.go
    chmod +x zivpn-api
    
    # Pastikan API Key & Port tersedia
    [ ! -f "/etc/zivpn/apikey" ] && openssl rand -hex 16 > /etc/zivpn/apikey
    echo "8888" > /etc/zivpn/api_port
    
    systemctl restart zivpn-api
    cd /etc/menu
fi

# 5. Pindahkan semua script ke /usr/bin dan Atur Permission
echo -e "${green}Applying Permissions to all scripts...${neutral}"
chmod +x *
mv * /usr/bin/

# Memberikan izin eksekusi masal di folder tujuan
chmod +x /usr/bin/apicreate
chmod +x /usr/bin/apidelete
chmod +x /usr/bin/apirenew
chmod +x /usr/bin/apicheck
chmod +x /usr/bin/apitrial-zivpn
chmod +x /usr/bin/menuzivpn
chmod +x /usr/bin/exp
chmod +x /usr/bin/update
chmod +x /usr/bin/limitipzivpn
chmod +x /usr/bin/menu

# 6. Membersihkan Sisa Update
cd
rm -rf /etc/menu

echo -e "${green}Update selesai. Seluruh file dan izin eksekusi telah diperbarui.${neutral}"