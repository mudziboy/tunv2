#!/bin/bash
# ============================================================
#  MASTER UPDATE SCRIPT â€” PREMIUM LIMITED EDITION
#  COMBINED WITH MASTER API (API.JS) DEPLOYMENT
#  BRANDING : TUNNEL OFFICIAL
# ============================================================

# Warna Pemikat
Green="\e[92;1m"
RED="\033[31m"
NC='\033[0m'
OR='\033[1;93m'

# Konfigurasi Repository
REPO_URL="https://raw.githubusercontent.com/mudziboy/tunv2/main/project/project.zip"
CONF_BASE="https://raw.githubusercontent.com/mudziboy/tunv2/main/config"
IZIN_URL="https://raw.githubusercontent.com/mudziboy/regist/main/izin"
BOT_ZIP_URL="https://raw.githubusercontent.com/mudziboy/doldol/main/bot.zip"
ZIP_PASS="Tunnelftdor"

echo -e "${Green}Memulai Proses Update Master & API Deployment...${NC}"

# 1. Sinkronisasi Perizinan [cite: 277, 278]
echo -e "${OR}Checking access permissions...${NC}"
ipsaya=$(curl -sS ipv4.icanhazip.com)
data=$(curl -sS $IZIN_URL)
if echo "$data" | grep -q "$ipsaya"; then
    echo -e "${Green}Akses Diterima!${NC}"
else
    echo -e "${RED}Akses Ditolak! VPS Anda tidak terdaftar.${NC}"
    exit 1
fi

# 2. Persiapan Direktori [cite: 278]
mkdir -p /etc/xray/vmess /etc/xray/vless /etc/xray/trojan /etc/xray/shadowsocks /etc/zivpn /etc/menu /etc/api-server

# 3. Update File Konfigurasi JSON [cite: 278]
echo -e "${OR}Updating configuration files...${NC}"
wget -q -O /etc/xray/vmess/config.json "${CONF_BASE}/vmess/config.json"
wget -q -O /etc/xray/vless/config.json "${CONF_BASE}/vless/config.json"
wget -q -O /etc/xray/trojan/config.json "${CONF_BASE}/trojan/config.json"
wget -q -O /etc/xray/shadowsocks/config.json "${CONF_BASE}/shadowsocks/config.json"
wget -q -O /etc/zivpn/config.json "${CONF_BASE}/zivpn/config.json"

# 4. Download dan Ekstrak Project ZIP (Binary Manajemen) [cite: 278, 279]
echo -e "${OR}Downloading and extracting project.zip...${NC}"
wget -q -O /tmp/project.zip "${REPO_URL}"
unzip -o -P "$ZIP_PASS" /tmp/project.zip -d /etc/menu/

# 5. Download dan Ekstrak Master API (bot.zip)
echo -e "${OR}Installing Master API dependencies (Node.js)...${NC}"
if ! command -v node &> /dev/null; then
    apt update && apt install nodejs npm -y
fi

echo -e "${OR}Extracting Master API (api.js)...${NC}"
wget -q -O /etc/api-server/bot.zip "${BOT_ZIP_URL}"
unzip -o /etc/api-server/bot.zip -d /etc/api-server/
cd /etc/api-server
npm install express >/dev/null 2>&1 # Install dependencies api.js

# 6. Keamanan API (Auth Key)
if [ ! -f /root/.key ]; then
    echo "TUNNELOFFICIAL" > /root/.key
fi

# 7. DISTRIBUSI & FIX LINE ENDINGS (dos2unix manual) 
echo -e "${OR}Fixing file formats and distributing binaries...${NC}"
find /etc/menu/ -type f -exec sed -i 's/\r$//' {} + # Bersihkan karakter Windows 
sed -i 's/\r$//' /etc/api-server/api.js 2>/dev/null
cp -f /etc/menu/* /usr/bin/ 2>/dev/null

# 8. Sinkronisasi Summary Akun ZiVPN di Menu [cite: 280, 281]
sed -i "s/zi_c=.*/zi_c=\$(jq '.auth.config | length' \/etc\/zivpn\/config.json 2>\/dev\/null || echo \"0\")/g" /usr/bin/menu

echo -e "${OR}Optimizing API Server Port & Security...${NC}"
# Memastikan port 5888 terbuka di sistem
iptables -I INPUT -p tcp --dport 5888 -j ACCEPT

# Memastikan api.js mendengarkan di 0.0.0.0 (Akses Publik)
sed -i "s/app.listen(PORT/app.listen(PORT, '0.0.0.0'/g" /etc/api-server/api.js

# 9. Membuat Service API Server
cat > /etc/systemd/system/api-server.service <<EOF
[Unit]
Description=Master VPN API Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/api-server
ExecStart=/usr/bin/node api.js
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 10. Pengaturan Izin Eksekusi & Firewall
chmod +x /usr/bin/*
chmod 644 /etc/zivpn/config.json
iptables -I INPUT -p tcp --dport 5888 -j ACCEPT # Buka port API

# 11. Restart Layanan [cite: 281, 282]
echo -e "${Green}Restarting all services...${NC}"
systemctl daemon-reload
systemctl enable api-server
systemctl restart api-server
services=("nginx" "xray" "vmess@config" "vless@config" "trojan@config" "shadowsocks@config" "zivpn" "zivpn-api")
for svc in "${services[@]}"; do
    systemctl restart $svc >/dev/null 2>&1
done

echo -e "${Green}Update Selesai Sempurna! API Server Berjalan di Port 5888.${NC}"
rm -f /tmp/project.zip
menu