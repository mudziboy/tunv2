#!/bin/bash
# ============================================================
#  MASTER UPDATE SCRIPT â€” TUNNEL OFFICIAL (SYNC AUTH VERSION)
#  PORT: 5888 (API.JS) & 8888 (ZIVPN-API)
# ============================================================

# Warna Pemikat
Green="\e[92;1m"
RED="\033[31m"
NC='\033[0m'
OR='\033[1;93m'

# Konfigurasi Repository
REPO_URL="https://raw.githubusercontent.com/mudziboy/tunv2/main/project/project.zip"
CONF_BASE="https://raw.githubusercontent.com/mudziboy/tunv2/main/config"
IZIN_URL="https://raw.githubusercontent.com/mudziboy/regist/main/izin"
BOT_ZIP_URL="https://raw.githubusercontent.com/mudziboy/doldol/main/bot.zip"
ZIP_PASS="Tunnelftdor"

echo -e "${Green}Memulai Proses Update Master & API Deployment...${NC}"

# 1. Sinkronisasi Perizinan & Auto-Auth
echo -e "${OR}Checking access permissions and syncing Auth...${NC}"
ipsaya=$(curl -sS ipv4.icanhazip.com)
data_izin=$(curl -sS "$IZIN_URL")

if echo "$data_izin" | grep -q "$ipsaya"; then
    # Mengambil Nama User (Kolom ke-2) dari file izin sebagai Auth Key
    auth_name=$(echo "$data_izin" | grep "$ipsaya" | awk '{print $2}')
    [[ -z "$auth_name" ]] && auth_name="TUNNELOFFICIAL"
    echo -e "${Green}Akses Diterima! Auth Key: $auth_name${NC}"
else
    echo -e "${RED}Akses Ditolak! VPS Anda tidak terdaftar.${NC}"
    exit 1
fi

# 2. Persiapan Direktori & Izin Log
mkdir -p /etc/xray/vmess /etc/xray/vless /etc/xray/trojan /etc/xray/shadowsocks /etc/zivpn /etc/menu /etc/api-server /etc/zivpn/api
mkdir -p /var/log/xray
chown -R www-data:www-data /var/log/xray
chmod -R 755 /var/log/xray

# 3. Update Konfigurasi ZiVPN
wget -q -O /etc/zivpn/config.json "${CONF_BASE}/zivpn/config.json"
echo "$auth_name" > /etc/zivpn/apikey # Sinkron Auth ke ZiVPN
echo "$auth_name" > /root/.key        # Sinkron Auth ke api.js

# 4. Download dan Ekstrak Project ZIP (Binary Manajemen Terminal)
echo -e "${OR}Downloading and extracting project.zip...${NC}"
wget -q -O /tmp/project.zip "${REPO_URL}"
unzip -o -P "$ZIP_PASS" /tmp/project.zip -d /etc/menu/

# 5. Instalasi Golang & Kompilasi ZiVPN API (Go)
echo -e "${OR}Setting up ZiVPN API (Golang) on Port 8888...${NC}"
if ! command -v go &> /dev/null; then
    apt update && apt install golang -y
fi
wget -q -O /etc/zivpn/api/zivpn-api.go "https://raw.githubusercontent.com/mudziboy/ziv/main/zivpn-api.go"
wget -q -O /etc/zivpn/api/go.mod "https://raw.githubusercontent.com/mudziboy/ziv/main/go.mod"
cd /etc/zivpn/api && go build -o /usr/bin/zivpn-api zivpn-api.go
chmod +x /usr/bin/zivpn-api

# 6. Instalasi Master API (api.js dari bot.zip)
echo -e "${OR}Installing api.js (Node.js) on Port 5888...${NC}"
if ! command -v node &> /dev/null; then
    apt update && apt install nodejs npm -y
fi
wget -q -O /etc/api-server/bot.zip "${BOT_ZIP_URL}"
unzip -o /etc/api-server/bot.zip -d /etc/api-server/
find /etc/api-server -name "api.js" -exec cp {} /etc/api-server/ \;
cd /etc/api-server && npm install express >/dev/null 2>&1

# 7. Distribusi Binari & Perbaikan Format
find /etc/menu/ -type f -exec sed -i 's/\r$//' {} + 
cp -f /etc/menu/* /usr/bin/ 2>/dev/null
chmod +x /usr/bin/*

# 8. Konfigurasi Khusus api.js (Port 5888 agar tidak bentrok)
sed -i 's/\r$//' /etc/api-server/api.js
sed -i "s/const PORT = .*/const PORT = 5888;/g" /etc/api-server/api.js
sed -i "s/app.listen(PORT/app.listen(PORT, '0.0.0.0'/g" /etc/api-server/api.js

# 9. Membuat Service API Server
cat > /etc/systemd/system/api-server.service <<EOF
[Unit]
Description=Master VPN API Server (Node.js)
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/api-server
ExecStart=/usr/bin/node api.js
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 10. Firewall (Buka Port 5888 & 8888)
iptables -I INPUT -p tcp --dport 5888 -j ACCEPT
iptables -I INPUT -p tcp --dport 8888 -j ACCEPT
mkdir -p /etc/iptables
iptables-save > /etc/iptables/rules.v4

# 11. Restart Semua Layanan
echo -e "${Green}Restarting all services...${NC}"
systemctl daemon-reload
systemctl enable api-server zivpn-api
systemctl restart api-server zivpn-api zivpn xray

echo -e "${Green}Update Selesai!${NC}"
echo -e "${OR}API Protokol: Port 5888${NC}"
echo -e "${OR}API ZiVPN: Port 8888${NC}"
echo -e "${OR}Auth Key: $auth_name${NC}"
rm -f /tmp/project.zip /etc/api-server/bot.zip
menu