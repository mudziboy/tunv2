#!/bin/bash
# ==========================================
# Full Update Script #tunv2 Project - ZIP Version
# ==========================================

# Color definitions
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;39m"


# 1. Validasi Izin Script (Original Logic)
ipsaya=$(wget -qO- ipinfo.io/ip)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")
data_ip="https://raw.githubusercontent.com/mudziboy/regist/main/izin"

# Pengecekan Izin Akses
useexp=$(wget -qO- $data_ip | grep $ipsaya | awk '{print $3}')
if [[ $date_list < $useexp ]]; then
    echo -e "${green}Permission Granted...${neutral}"
else
    echo -e "${red}PERMISSION DENIED! Contact Admin.${neutral}"
    exit 1
fi

echo -e "${blue}Memulai proses update masal, mohon tunggu...${neutral}"

# 2. Instalasi Dependensi yang dibutuhkan
apt update -y && apt install golang dos2unix p7zip-full -y

mkdir -p /etc/xray/zivpn
touch /etc/xray/zivpn/.zivpn.db

# 3. Proses Download dan Ekstrak ZIP
mkdir -p /etc/menu
cd /etc/menu
url="https://github.com/mudziboy/tunv2/raw/main/project/project.zip"

wget -O menu.zip "$url"
7z e -pTunnelftdor menu.zip >/dev/null 2>&1

# Fix Format File (Windows to Linux)
find . -type f -exec dos2unix {} \; >/dev/null 2>&1

# ... (kode awal skrip Anda)

# 4. Integrasi & Re-Compile ZiVPN API (REVISI OTOMATISASI PORT 8888)
if [ -f "zivpn-api.go" ]; then
    echo -e "${green}Re-compiling ZiVPN API & Fixing Port 8888...${neutral}"
    mkdir -p /etc/zivpn/api
    mv zivpn-api.go /etc/zivpn/api/zivpn-api.go
    mv go.mod /etc/zivpn/api/go.mod 2>/dev/null
    
    cd /etc/zivpn/api
    rm -f go.mod go.sum zivpn-api
    go mod init zivpn
    go mod tidy
    go build -o zivpn-api zivpn-api.go
    chmod +x zivpn-api
    
    # Pastikan API Key & Port tersedia 
    [ ! -f "/etc/zivpn/apikey" ] && openssl rand -hex 16 > /etc/zivpn/apikey
    echo "8888" > /etc/zivpn/api_port 

    # --- TAMBAHKAN KODE INI UNTUK MEMBUKA PORT PERMANEN ---
    cat <<EOF > /etc/systemd/system/zivpn-api.service
[Unit]
Description=ZiVPN API Server Port 8888
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn/api
ExecStart=/etc/zivpn/api/zivpn-api
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

    # Membuka port di firewall jika ada
    iptables -I INPUT -p tcp --dport 8888 -j ACCEPT
    iptables -I INPUT -p udp --dport 8888 -j ACCEPT
    
    systemctl daemon-reload
    systemctl enable zivpn-api
    systemctl restart zivpn-api
    
    cd /etc/menu
fi

# ==========================================
# OTOMATISASI LIMIT IP ZIVPN
# ==========================================
echo -e "${green}Automating Limit IP Service...${neutral}"

# 1. Memberikan izin eksekusi otomatis 
chmod +x /usr/bin/limitipzivpn

# 2. Membuat file log agar tidak error [cite: 248]
mkdir -p /var/log/zivpn
touch /var/log/zivpn/limit.log

# 3. Membuat Service Systemd secara otomatis [cite: 149]
cat <<EOF > /etc/systemd/system/zivpn-limit.service
[Unit]
Description=ZiVPN IP Limit Daemon
After=network.target zivpn-api.service

[Service]
Type=simple
ExecStart=/usr/bin/limitipzivpn
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

# 4. Mengaktifkan Service secara otomatis
systemctl daemon-reload
systemctl enable zivpn-limit
systemctl restart zivpn-limit

# 5. Pindahkan semua script ke /usr/bin dan Atur Permission
echo -e "${green}Applying Permissions to all scripts...${neutral}"
chmod +x *
mv * /usr/bin/

# Memberikan izin eksekusi masal di folder tujuan
chmod +x /usr/bin/apicreate
chmod +x /usr/bin/apidelete
chmod +x /usr/bin/apirenew
chmod +x /usr/bin/apicheck
chmod +x /usr/bin/apitrial-zivpn
chmod +x /usr/bin/menuzivpn
chmod +x /usr/bin/exp
chmod +x /usr/bin/update
chmod +x /usr/bin/limitipzivpn
chmod +x /usr/bin/menu
chmod +x /usr/bin/add-zivpn
chmod +x /usr/bin/apidelete-zivpn
chmod +x /usr/bin/apicreate-zivpn
chmod +x /usr/bin/apirenew-zivpn
chmod +x /usr/bin/backupstore
chmod +x /usr/bin/del-zivpn
chmod +x /usr/bin/install-zivpn
chmod +x /usr/bin/apidelete-zivpn
chmod +x /usr/bin/renew-zivpn
chmod +x /usr/bin/trial-zivpn


# 6. Membersihkan Sisa Update
cd
rm -rf /etc/menu

echo -e "${green}Update selesai. Seluruh file dan izin eksekusi telah diperbarui.${neutral}"