#!/bin/bash
# ============================================================
#  UPDATE SCRIPT — PREMIUM LIMITED EDITION
#  BRANDING : TUNNEL OFFICIAL #TUNV2
# ============================================================

# Warna
Green="\e[92;1m"
RED="\033[31m"
NC='\033[0m'
OR='\033[1;93m'

# Konfigurasi Repository
REPO_URL="https://github.com/mudziboy/tunv2/raw/main/project/project.zip"
IZIN_URL="https://raw.githubusercontent.com/mudziboy/regist/main/izin"
ZIP_PASS="Tunnelftdor"

# Ambil Data Server
ipsaya=$(wget -qO- ipinfo.io/ip)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")

# ===============================
# CEK PERMISSION (Pusat Izin)
# ===============================
checking_sc() {
  useexp=$(wget -qO- $IZIN_URL | grep $ipsaya | awk '{print $3}')
  if [[ $date_list < $useexp ]]; then
    echo -ne
  else
    echo -e "${OR}────────────────────────────────────────────${NC}"
    echo -e "\033[42m          TUNNEL OFFICIAL           ${NC}"
    echo -e "${OR}────────────────────────────────────────────${NC}"
    echo -e ""
    echo -e "            ${RED}PERMISSION DENIED !${NC}"
    echo -e "   \033[0;33mYour VPS${NC} $ipsaya \033[0;33mHas been Banned${NC}"
    echo -e "     \033[0;33mBuy access permissions for scripts${NC}"
    echo -e "             \033[0;33mContact Admin :${NC}"
    echo -e "      ${Green}WhatsApp${NC} wa.me/628..."
    echo -e "${OR}────────────────────────────────────────────${NC}"
    exit
  fi
}
checking_sc

# ===============================
# PROSES UPDATE
# ===============================
echo -e "${Green}Memulai proses update, mohon tunggu...${NC}"

# 1. Pastikan unzip terinstall
apt install unzip -y > /dev/null 2>&1

# 2. Persiapan Folder
mkdir -p /etc/menu
cd /tmp

# 3. Download Project ZIP
echo -e "${OR}Downloading project update...${NC}"
wget -O project.zip "$REPO_URL"

# 4. Ekstrak dengan Password
# -o: Overwrite file lama
# -P: Password ZIP
echo -e "${OR}Extracting update files...${NC}"
unzip -o -P "$ZIP_PASS" project.zip -d /etc/menu/

# 5. Distribusi File ke /usr/bin
echo -e "${OR}Distributing system files...${NC}"
cp -f /etc/menu/* /usr/bin/ 2>/dev/null

# 6. PEMBERIAN IZIN (CHMOD +X)
# Ini adalah bagian paling krusial agar tidak ada error permission
echo -e "${OR}Setting permissions (chmod +x)...${NC}"
chmod +x /usr/bin/*
chmod +x /etc/menu/*

# 7. Restart Service yang berkaitan (Termasuk ZiVPN)
echo -e "${Green}Restarting services...${NC}"
systemctl daemon-reload
services=("zivpn" "zivpn-api" "ssh" "nginx" "xray")
for svc in "${services[@]}"; do
    systemctl restart $svc >/dev/null 2>&1
done

# 8. Bersihkan File Sampah
rm -f /tmp/project.zip

echo -e "${Green}Update Selesai Sempurna!${NC}"
echo -e "${OR}Silakan ketik 'menu' untuk melihat perubahan.${NC}"
sleep 2
menu