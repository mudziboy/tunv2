#!/bin/bash
# ============================================================
#  REPAIR & UPDATE SCRIPT â€” TUNNEL OFFICIAL #TUNV2
# ============================================================

Green="\e[92;1m"
RED="\033[31m"
NC='\033[0m'
OR='\033[1;93m'

# Konfigurasi Repository (SESUAIKAN DENGAN STRUKTUR GITHUB ANDA)
REPO_URL="https://raw.githubusercontent.com/mudziboy/tunv2/main/project/project.zip"
# Pastikan jalur folder di bawah ini benar-benar ada di GitHub
CONF_VMESS="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/vmess/config.json"
CONF_VLESS="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/vless/config.json"
CONF_TROJAN="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/trojan/config.json"
CONF_SS="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/shadowsocks/config.json"

echo -e "${Green}Memulai perbaikan konfigurasi...${NC}"

# 1. Unduh ulang Config Xray yang gagal di setup
mkdir -p /etc/xray/vmess /etc/xray/vless /etc/xray/trojan /etc/xray/shadowsocks
wget -q -O /etc/xray/vmess/config.json "${CONF_VMESS}" || echo -e "${RED}Gagal ambil VMESS${NC}"
wget -q -O /etc/xray/vless/config.json "${CONF_VLESS}" || echo -e "${RED}Gagal ambil VLESS${NC}"
wget -q -O /etc/xray/trojan/config.json "${CONF_TROJAN}" || echo -e "${RED}Gagal ambil TROJAN${NC}"
wget -q -O /etc/xray/shadowsocks/config.json "${CONF_SS}" || echo -e "${RED}Gagal ambil SS${NC}"

# 2. Sinkronisasi file Manajemen dari project.zip
wget -q -O /tmp/project.zip "${REPO_URL}"
unzip -o -P Tunnelftdor /tmp/project.zip -d /etc/menu/
cp -f /etc/menu/* /usr/bin/
chmod +x /usr/bin/*

# 3. Jalankan pembaruan UUID (Agar config sinkron)
uuid=$(cat /proc/sys/kernel/random/uuid)
for conf in vmess vless trojan shadowsocks; do
    if [ -f "/etc/xray/$conf/config.json" ]; then
        sed -i "s/1d1c1d94-6987-4658-a4dc-8821a30fe7e0/$uuid/g" /etc/xray/$conf/config.json
    fi
done

# 4. Restart Services
systemctl daemon-reload
services=("zivpn" "zivpn-api" "ssh" "nginx" "xray" "vmess@config" "vless@config" "trojan@config" "shadowsocks@config")
for svc in "${services[@]}"; do
    systemctl restart $svc >/dev/null 2>&1
done

echo -e "${Green}Update & Repair Selesai Sempurna!${NC}"
menu