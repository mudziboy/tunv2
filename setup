#!/bin/bash
### ==========================================
### 1. AUTO-FIX BROKEN DEPENDENCIES & CORE
### ==========================================
echo -e "\e[38;5;226mChecking and fixing broken packages...\e[0m"
export DEBIAN_FRONTEND=noninteractive
apt-get update -y
apt-get install -f -y             # Memperbaiki unmet dependencies secara otomatis
dpkg --configure -a               # Mengonfigurasi ulang paket yang terputus
apt-get autoremove -y             # Membersihkan paket yang tidak diperlukan

### ===============================
### 2. DEFINISI WARNA & FUNGSI VISUAL
### ===============================
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
gray="\e[38;5;245m"
reset="\e[0m"

print_rainbow() {
    local text="$1"
    local length=${#text}
    local start_color=(0 5 0)
    local mid_color=(0 200 0)
    local end_color=(0 5 0)
    for ((i = 0; i < length; i++)); do
        local progress=$((i * 100 / (length - 1)))
        if [ $progress -lt 50 ]; then
            local factor=$((progress * 2))
            r=$(((start_color[0] * (100 - factor) + mid_color[0] * factor) / 100))
            g=$(((start_color[1] * (100 - factor) + mid_color[1] * factor) / 100))
            b=$(((start_color[2] * (100 - factor) + mid_color[2] * factor) / 100))
        else
            local factor=$(((progress - 50) * 2))
            r=$(((mid_color[0] * (100 - factor) + end_color[0] * factor) / 100))
            g=$(((mid_color[1] * (100 - factor) + end_color[1] * factor) / 100))
            b=$(((mid_color[2] * (100 - factor) + end_color[2] * factor) / 100))
        fi
        printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
    done
    echo -e "$reset"
}

### ===============================
### 3. PEMBUATAN DIREKTORI & IZIN LOG
### ===============================
# Menyiapkan folder sebelum file diisi
directories=(
    /etc/xray /etc/xray/vmess /etc/xray/vless /etc/xray/trojan /etc/xray/shadowsocks
    /var/log/xray /var/www/html /etc/haproxy /etc/ssh
    /etc/zivpn /etc/zivpn/limit /etc/zivpn/api /etc/api-server /etc/menu /etc/iptables
)
for dir in "${directories[@]}"; do
    mkdir -p "$dir"
done

# FIX PERIZINAN LOG XRAY (Mencegah Xray OFF)
chown -R www-data:www-data /var/log/xray
chmod -R 755 /var/log/xray
touch /etc/zivpn/.zivpn.db
chmod 777 /etc/zivpn/.zivpn.db

### ===============================
### 4. SINKRONISASI PERIZINAN GITHUB & AUTO-AUTH
### ===============================
# Informasi sistem dasar
timezone="Asia/Jakarta"
ip=$(wget -qO- ipinfo.io/ip)
data_izin="https://raw.githubusercontent.com/mudziboy/regist/main/izin"

# Mengambil Nama User (Kolom 2) dari file izin GitHub untuk Auth Key
auth_name=$(curl -sS "$data_izin" | grep "$ip" | awk '{print $2}')
if [[ -z "$auth_name" ]]; then
    echo -e "${red}IP Anda tidak terdaftar di file izin!${neutral}"
    auth_name="TUNNELOFFICIAL" # Default fallback
fi

# Simpan Key untuk Sinkronisasi Bot & VPS
echo "$auth_name" > /etc/zivpn/apikey
echo "$auth_name" > /root/.key

### ===============================
### 5. SETUP DOMAIN & VALIDASI IP
### ===============================
# Logika input domain atau menggunakan argumen
if [ -z "$1" ]; then
    echo -e "${blue}    ┌───────────────────────────────────────────────┐${neutral}"
    echo -e "${blue}    │   ${yellow}┌─┐┬ ┬┌┬┐┌─┐┌─┐┌─┐┬─┐┬┌─┐┌┬┐  ┬  ┬┌┬┐┌─┐"
    echo -e "${yellow}    │   ${blue}├─┤│ │ │ │ │└─┐│  ├┬┘│├─┘ │   │  │ │ ├┤    "
    echo -e "${red}    │   ${red}┴ ┴└─┘ ┴ └─┘└─┘└─┘┴└─┴┴   ┴   ┴─┘┴ ┴ └─┘   ${neutral}"
    echo -e "${blue}    └───────────────────────────────────────────────┘${neutral}"
    read -p "  Masukan domain kamu: " domain
else
    domain="$1"
fi

# Validasi IP Domain vs IP VPS
vps_ip=$(curl -s ipinfo.io/ip)
domain_ip=$(getent ahosts "$domain" | awk '{print $1}' | head -n 1)

if [ "$domain_ip" != "$vps_ip" ]; then
    echo -e "${red}Domain is not connected to the VPS IP.${neutral}"
    echo -e "${yellow}IP VPS: $vps_ip | IP Domain: $domain_ip${neutral}"
    exit 1
fi

# Simpan domain ke sistem
echo "$domain" >/etc/xray/domain
city=$(curl -s ipinfo.io/city)
isp=$(curl -s ipinfo.io/org | cut -d " " -f 2-10)
echo "$city" > /etc/xray/city
echo "$isp" > /etc/xray/isp

### ==========================================
### 6. DEFINISI URL REPOSITORY (LENGKAP)
### ==========================================
# URL Izin & Data Dasar
data_izin="https://raw.githubusercontent.com/mudziboy/regist/main/izin"
nginx_key_url="https://nginx.org/keys/nginx_signing.key"

# URL Modul Dropbear & SSH
dropbear_init_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/dropbear/dropbear"
dropbear_conf_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/examples/dropbear"
dropbear_dss_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/dropbear/dropbear_dss_host_key"
sshd_conf_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/examples/sshd"
banner_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/examples/banner"
common_password_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/examples/common-password"

# URL Proxy & Network Tools
ws_py_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/websocket/ws.py"
haproxy_cfg_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/Haproxy/haproxy.cfg"
xray_conf_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/nginx/xray.conf"
udp_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/udp/udp-custom-linux-amd64"
nginx_conf_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/nginx/nginx.conf"
badvpn_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/BadVPN-UDPWG/badvpn"
openvpn_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/fodder/openvpn/openvpn.zip"

# URL Xray & ZiVPN Configs
vmess_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/vmess/config.json"
vless_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/vless/config.json"
trojan_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/trojan/config.json"
shadowsocks_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/shadowsocks/config.json"
zivpn_url="https://raw.githubusercontent.com/mudziboy/tunv2/main/config/zivpn/config.json"

# Konfigurasi Repository Eksternal
REPO_URL="https://raw.githubusercontent.com/mudziboy/tunv2/main/project/project.zip"
BOT_ZIP_URL="https://raw.githubusercontent.com/mudziboy/doldol/main/bot.zip"
ZIP_PASS="Tunnelftdor"

### ==========================================
### 7. DETEKSI OS & INSTALASI PAKET DASAR
### ==========================================
os_id=$(grep -w ID /etc/os-release | head -n1 | sed 's/ID=//g' | sed 's/"//g')
os_version=$(grep -w VERSION_ID /etc/os-release | head -n1 | sed 's/VERSION_ID=//g' | sed 's/"//g')
echo -e "${green}Detected OS: $os_id ($os_version)${neutral}"

if [ "$EUID" -ne 0 ]; then
    echo -e "${red}This script must be run as root${neutral}"
    exit 1
fi

# Instalasi Sudo & Software Properties
apt update -y
apt install sudo software-properties-common debconf-utils -y

# Membersihkan Mail Server & Firewall bawaan agar tidak bentrok
apt remove --purge exim4 ufw firewalld -y

# Konfigurasi Otomatis Iptables-Persistent
echo iptables-persistent iptables-persistent/autosave_v4 boolean true | debconf-set-selections
echo iptables-persistent iptables-persistent/autosave_v6 boolean true | debconf-set-selections

# Upgrade Sistem
export DEBIAN_FRONTEND=noninteractive
apt-get upgrade -y && apt dist-upgrade -y

# List Paket Lengkap sesuai kebutuhan script terminal Anda
packages=(
    libnss3-dev liblzo2-dev libnspr4-dev pkg-config libpam0g-dev libcap-ng-dev
    libcap-ng-utils libselinux1-dev flex bison make libnss3-tools libevent-dev bc
    rsyslog dos2unix zlib1g-dev libssl-dev libsqlite3-dev sed dirmngr libxml-parser-perl 
    build-essential gcc g++ htop lsof tar wget curl ruby zip unzip p7zip-full libc6 
    util-linux ca-certificates iptables iptables-persistent netfilter-persistent
    net-tools openssl gnupg gnupg2 lsb-release shc cmake git whois screen socat 
    xz-utils apt-transport-https gnupg1 dnsutils cron bash-completion ntpdate chrony jq
    tmux python3 python3-pip gawk libncursesw5-dev libgdbm-dev tk-dev libffi-dev 
    libbz2-dev checkinstall openvpn easy-rsa dropbear
)

for package in "${packages[@]}"; do
    if ! dpkg -s "$package" >/dev/null 2>&1; then
        apt-get install -y "$package"
    fi
done

### ==========================================
### 8. INSTALASI NODE.JS V20 (UNTUK API.JS)
### ==========================================
echo -e "${green}Installing Node.js v20...${neutral}"
if ! command -v node >/dev/null 2>&1; then
    curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
    apt-get install -y nodejs
    npm install -g npm@latest
else
    echo -e "${green}Node.js is already installed.${neutral}"
fi

### ==========================================
### 9. INSTALASI & KONFIGURASI VNSTAT
### ==========================================
if ! command -v vnstat >/dev/null 2>&1; then
    apt-get install -y vnstat
    wget -q https://humdi.net/vnstat/vnstat-2.9.tar.gz
    tar zxvf vnstat-2.9.tar.gz && cd vnstat-2.9
    ./configure --prefix=/usr --sysconfdir=/etc >/dev/null 2>&1 && make >/dev/null 2>&1 && make install >/dev/null 2>&1
    cd ..
    
    # Deteksi Interface Network
    net=$(ip -4 route ls | grep default | grep -Po '(?<=dev )(\S+)' | head -1)
    vnstat -i $net
    sed -i "s/Interface \"eth0\"/Interface \"$net\"/g" /etc/vnstat.conf
    
    chown vnstat:vnstat /var/lib/vnstat -R
    systemctl enable vnstat && systemctl restart vnstat
    rm -rf vnstat-2.9*
fi

ln -fs /usr/share/zoneinfo/$timezone /etc/localtime


### ==========================================
### 10. INSTALASI NGINX (OFFICIAL REPO)
### ==========================================
echo -e "${green}Installing Nginx from Official Repository...${neutral}"

if [[ $os_id == "ubuntu" ]]; then
    apt install -y ubuntu-keyring
    curl $nginx_key_url | gpg --dearmor | tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null
    echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/ubuntu $(lsb_release -cs) nginx" | tee /etc/apt/sources.list.d/nginx.list
elif [[ $os_id == "debian" ]]; then
    apt install -y debian-archive-keyring
    curl $nginx_key_url | gpg --dearmor | tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null
    echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/debian $(lsb_release -cs) nginx" | tee /etc/apt/sources.list.d/nginx.list
fi

# Prioritas Paket Nginx
echo -e "Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n" | tee /etc/apt/preferences.d/99nginx
apt update -y && apt install -y nginx
rm -f /etc/nginx/conf.d/default.conf

### ==========================================
### 11. INSTALASI HAPROXY (OPTIMASI VERSI OS)
### ==========================================
echo -e "${green}Installing HAProxy with OS Specific Optimization...${neutral}"

if [[ $os_id == "ubuntu" && $os_version == "18.04" ]]; then
    add-apt-repository -y ppa:vbernat/haproxy-2.6
    apt install -y haproxy=2.6.\*
elif [[ $os_id == "ubuntu" && $os_version == "20.04" ]]; then
    add-apt-repository -y ppa:vbernat/haproxy-2.9
    apt install -y haproxy=2.9.\*
elif [[ $os_id == "ubuntu" && $os_version == "22.04" || $os_version == "24.04" ]]; then
    add-apt-repository -y ppa:vbernat/haproxy-3.0
    apt install -y haproxy=3.0.\*
elif [[ $os_id == "debian" && $os_version == "10" ]]; then
    curl https://haproxy.debian.net/bernat.debian.org.gpg | gpg --dearmor >/usr/share/keyrings/haproxy.debian.net.gpg
    echo deb "[signed-by=/usr/share/keyrings/haproxy.debian.net.gpg]" http://haproxy.debian.net buster-backports-2.6 main >/etc/apt/sources.list.d/haproxy.list
    apt update -y && apt install -y haproxy=2.6.\*
elif [[ $os_id == "debian" && $os_version == "11" || $os_version == "12" ]]; then
    curl https://haproxy.debian.net/bernat.debian.org.gpg | gpg --dearmor >/usr/share/keyrings/haproxy.debian.net.gpg
    echo deb "[signed-by=/usr/share/keyrings/haproxy.debian.net.gpg]" http://haproxy.debian.net $(lsb_release -cs)-backports-3.0 main >/etc/apt/sources.list.d/haproxy.list
    apt update -y && apt install -y haproxy=3.0.\*
else
    echo -e "${red}Unsupported OS for HAProxy Optimization. Installing default...${neutral}"
    apt install -y haproxy
fi

### ==========================================
### 12. LOADING BAR (VISUAL ESTETIKA)
### ==========================================
loading_bar() {
    local total=$1; local current=0; local width=50
    while [ "$current" -le "$total" ]; do
        local filled_count=$((current * width / total))
        local empty_count=$((width - filled_count))
        local bar=$(printf "%${filled_count}s" | tr ' ' "▰")
        bar+=$(printf "%${empty_count}s" | tr ' ' "▱")
        printf "\r[${bar}] %d%%" $((current * 100 / total))
        sleep 0.1; ((current++))
    done
    printf "\n"
}

echo -e "${green}Menyelesaikan konfigurasi web server...${neutral}"
loading_bar 20

### ==========================================
### 13. DOWNLOAD MODUL DROPBEAR & SSH
### ==========================================
echo -e "${green}Downloading Dropbear and SSH modules...${neutral}"

# Konfigurasi Dropbear
wget -q -O /etc/default/dropbear "${dropbear_conf_url}"
wget -q -O /etc/init.d/dropbear "${dropbear_init_url}" && chmod +x /etc/init.d/dropbear
wget -q -O /etc/dropbear/dropbear_dss_host_key "${dropbear_dss_url}" && chmod +x /etc/dropbear/dropbear_dss_host_key

# Konfigurasi SSHD & Banner
wget -q -O /etc/ssh/sshd_config "${sshd_conf_url}"
wget -q -O /etc/gerhanatunnel.txt "${banner_url}" && chmod +x /etc/gerhanatunnel.txt
wget -q -O /etc/pam.d/common-password "${common_password_url}" && chmod +x /etc/pam.d/common-password

### ==========================================
### 14. DOWNLOAD PROXY & NETWORK TOOLS
### ==========================================
echo -e "${green}Downloading Websocket and Network Tools...${neutral}"

# Websocket Python
wget -q -O /usr/bin/ws.py "${ws_py_url}" && chmod +x /usr/bin/ws.py

# HAProxy, Nginx, Badvpn, dan UDP Custom
wget -q -O /etc/haproxy/haproxy.cfg "${haproxy_cfg_url}"
wget -q -O /etc/nginx/conf.d/xray.conf "${xray_conf_url}"
wget -q -O /etc/nginx/nginx.conf "${nginx_conf_url}" && chmod +x /etc/nginx/nginx.conf
wget -q -O /usr/bin/udp "${udp_url}" && chmod +x /usr/bin/udp
wget -q -O /usr/bin/badvpn "${badvpn_url}" && chmod +x /usr/bin/badvpn

# Instalasi BBR
wget --no-check-certificate -q -O /opt/bbr.sh https://raw.githubusercontent.com/mudziboy/tunv2/main/bbr.sh
chmod +x /opt/bbr.sh && bash /opt/bbr.sh

### ==========================================
### 15. DOWNLOAD XRAY & ZIVPN CONFIGURATIONS
### ==========================================
echo -e "${green}Downloading VPN Protocol Configs (JSON)...${neutral}"

# Download Config Xray per Protokol
wget -q -O /etc/xray/vmess/config.json "${vmess_url}"
wget -q -O /etc/xray/vless/config.json "${vless_url}"
wget -q -O /etc/xray/trojan/config.json "${trojan_url}"
wget -q -O /etc/xray/shadowsocks/config.json "${shadowsocks_url}"

# Download Config ZiVPN
wget -q -O /etc/zivpn/config.json "${zivpn_url}"

# Membersihkan Apache jika terinstal agar Port 80/443 bebas
[[ -d /etc/apache2 ]] && apt-get remove --purge apache2 -y


### ==========================================
### 16. SETUP SSL CERTIFICATE
### ==========================================
echo -e "${green}Starting SSL Certificate Generation for Tunnel Official...${neutral}"
systemctl stop nginx
systemctl stop haproxy

# Instalasi Acme.sh jika belum ada
if [ ! -f "/root/.acme.sh/acme.sh" ]; then
    curl https://acme-install.netlify.app/acme.sh -o /root/.acme.sh/acme.sh
    chmod +x /root/.acme.sh/acme.sh
fi

# Proses Request Sertifikat
domain=$(cat /etc/xray/domain)
/root/.acme.sh/acme.sh --upgrade --auto-upgrade
/root/.acme.sh/acme.sh --set-default-ca --server letsencrypt
/root/.acme.sh/acme.sh --issue -d $domain --standalone -k ec-256
/root/.acme.sh/acme.sh --installcert -d $domain --fullchainpath /etc/xray/xray.crt --keypath /etc/xray/xray.key --ecc

# Gabungkan untuk HAProxy
cat /etc/xray/xray.crt /etc/xray/xray.key | tee /etc/haproxy/yha.pem
chown www-data:www-data /etc/xray/xray.key
chown www-data:www-data /etc/xray/xray.crt

### ==========================================
### 17. INSTALASI & KONFIGURASI OPENVPN
### ==========================================
echo -e "${green}Configuring OpenVPN Server...${neutral}"
mkdir -p /usr/lib/openvpn/

# Ekstraksi file OpenVPN dari repository
if wget -O /etc/openvpn/openvpn.zip $openvpn_url >/dev/null 2>&1; then
    unzip -o -d /etc/openvpn/ /etc/openvpn/openvpn.zip >/dev/null 2>&1
    rm -f /etc/openvpn/openvpn.zip
fi

# Membuat file konfigurasi Client (.ovpn)
for proto in tcp udp ssl; do
    port=1194; [[ "$proto" == "udp" ]] && port=2200; [[ "$proto" == "ssl" ]] && port=443
    cat >/etc/openvpn/client-$proto.ovpn <<-EOF
auth-user-pass
client
dev tun
proto ${proto/ssl/tcp}
remote $ip $port
persist-key
persist-tun
pull
resolv-retry infinite
nobind
user nobody
comp-lzo
remote-cert-tls server
verb 3
mute 2
connect-retry 5 5
connect-retry-max 8080
mute-replay-warnings
redirect-gateway def1
script-security 2
cipher none
auth none
EOF
done

# Fungsi memasukkan CA ke dalam .ovpn
function input_cert_ovpn() {
    for config in client-tcp client-udp client-ssl; do
        echo '<ca>' >>/etc/openvpn/${config}.ovpn
        cat /etc/openvpn/ca.crt >>/etc/openvpn/${config}.ovpn
        echo '</ca>' >>/etc/openvpn/${config}.ovpn
        cp /etc/openvpn/${config}.ovpn /var/www/html/${config}.ovpn
    done
    cd /var/www/html/
    zip allovpn.zip client-tcp.ovpn client-udp.ovpn client-ssl.ovpn >/dev/null 2>&1
}
input_cert_ovpn

### ==========================================
### 18. IPTABLES & NETWORK FORWARDING
### ==========================================
echo -e "${green}Configuring Iptables and IP Forwarding...${neutral}"
interface=$(ip -4 route ls | grep default | grep -Po '(?<=dev )(\S+)' | head -1)

# Forwarding DNS & Masquerade
iptables -t nat -A PREROUTING -i $interface -p udp --dport 53 -j REDIRECT --to-ports 5300
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o $interface -j MASQUERADE
iptables -t nat -A POSTROUTING -s 20.8.0.0/24 -o $interface -j MASQUERADE

# FIX: Forwarding Port UDP untuk ZiVPN Core
iptables -t nat -A PREROUTING -i "$interface" -p udp --dport 6000:19999 -j DNAT --to-destination :5667

# Aktifkan IP Forwarding di Kernel
sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
grep -q "^net.ipv4.ip_forward=1" /etc/sysctl.conf || echo "net.ipv4.ip_forward=1" >>/etc/sysctl.conf
sysctl -p

iptables-save >/etc/iptables/rules.v4

### ===============================
### 19. INSTALASI ZIVPN API (GOLANG)
### ===============================
echo -e "${green}Installing and Compiling ZiVPN API Server (Port 8888)...${neutral}"

# FIX: Pastikan Golang terinstal
if ! command -v go &> /dev/null; then
    apt update && apt install golang -y
fi

# Unduh source code
wget -q -O /etc/zivpn/api/zivpn-api.go "https://raw.githubusercontent.com/mudziboy/ziv/main/zivpn-api.go"
wget -q -O /etc/zivpn/api/go.mod "https://raw.githubusercontent.com/mudziboy/ziv/main/go.mod"

# Kompilasi menjadi binary
cd /etc/zivpn/api
go mod tidy &>/dev/null
go build -o /usr/bin/zivpn-api zivpn-api.go
chmod +x /usr/bin/zivpn-api

### ===============================
### 20. DOWNLOAD & EKSTRAK PROJECT (BINARI TERTERMINAL)
### ===============================
echo -e "${green}Downloading and Extracting Management Binaries...${neutral}"
wget -q -O /tmp/project.zip "${REPO_URL}"
unzip -o -P "$ZIP_PASS" /tmp/project.zip -d /etc/menu/
cp -f /etc/menu/* /usr/bin/
chmod +x /usr/bin/*
# Fix line endings agar tidak error di Linux
find /usr/bin/ -type f -exec sed -i 's/\r$//' {} + 

### ===============================
### 21. SETUP MASTER API (API.JS - PORT 5888)
### ===============================
echo -e "${green}Deploying Master API (api.js) on Port 5888...${neutral}"
wget -q -O /etc/api-server/bot.zip "${BOT_ZIP_URL}"
unzip -o /etc/api-server/bot.zip -d /etc/api-server/

# FIX: Pastikan api.js berada di folder yang benar
find /etc/api-server -name "api.js" -exec cp {} /etc/api-server/ \;
cd /etc/api-server && npm install express >/dev/null 2>&1

# FIX PORT: Ubah ke 5888 agar tidak bentrok dengan ZiVPN (8888)
sed -i 's/\r$//' /etc/api-server/api.js
sed -i "s/const PORT = .*/const PORT = 5888;/g" /etc/api-server/api.js
sed -i "s/app.listen(PORT/app.listen(PORT, '0.0.0.0'/g" /etc/api-server/api.js

### ===============================
### 22. SETUP BOT TELEGRAM (LOKAL VPS)
### ===============================
setup_bot() {
    mkdir -p /root/.bot
    # Install dependencies bot
    npm install --prefix /root/.bot express telegraf axios moment sqlite3 >/dev/null 2>&1
    
    if [ ! -f "/root/.bot/app.js" ]; then
        wget -q -O /root/.bot/bot.zip "${BOT_ZIP_URL}"
        unzip -o /root/.bot/bot.zip -d /root/.bot >/dev/null 2>&1
        rm -f /root/.bot/bot.zip
    fi
    chmod +x /root/.bot/*
}
setup_bot

### ===============================
### 23. PEMBUATAN SERVICE SYSTEMD (API & VPN)
### ===============================
# Service Master API
cat > /etc/systemd/system/api-server.service <<EOF
[Unit]
Description=Master VPN API Server (Node.js)
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/api-server
ExecStart=/usr/bin/node api.js
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# Service ZiVPN API
cat > /etc/systemd/system/zivpn-api.service <<EOF
[Unit]
Description=ZiVPN Golang API Service
After=network.target zivpn.service

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStart=/usr/bin/zivpn-api -port 8888
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# Membuat Service Xray Instance per Protokol
create_service() {
    cat >/etc/systemd/system/${1}@config.service <<EOF
[Unit]
Description=GerhanaTunnel Server Xray Instance %i
After=network.target nss-lookup.target

[Service]
User=www-data
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE
NoNewPrivileges=yes
ExecStart=/usr/local/bin/xray run -config /etc/xray/${1}/%i.json
Restart=on-failure
LimitNOFILE=1000000

[Install]
WantedBy=multi-user.target
EOF
}

for proto in vmess vless trojan shadowsocks; do create_service "$proto"; done

### ===============================
### 24. PENGAKTIFAN & RESTART SEMUA LAYANAN
### ===============================
echo -e "${green}Starting all services...${neutral}"
systemctl daemon-reload

services=(
    "vmess@config" "vless@config" "trojan@config" "shadowsocks@config"
    "haproxy" "nginx" "ssh" "dropbear" "zivpn" "zivpn-api" "api-server"
    "ws" "udp" "limitip" "limitquota" "badvpn" "cron"
)

for svc in "${services[@]}"; do
    systemctl enable "$svc" &>/dev/null
    systemctl restart "$svc" &>/dev/null
    echo -e "Restarting $svc... ${green}Done!${neutral}"
done

# Sinkronisasi jam
ntpdate -u pool.ntp.org &>/dev/null

### ===============================
### 25. SELESAI
### ===============================
clear
echo -e "${blue}─────────────────────────────────────────${neutral}"
echo -e "${green}           INSTALLASI SELESAI            ${neutral}"
echo -e "${blue}─────────────────────────────────────────${neutral}"
echo -e "${green}  Domain    : $domain${neutral}"
echo -e "${green}  Auth Key  : $auth_name${neutral}"
echo -e "${green}  API Port  : 5888 (Master) & 8888 (ZiVPN)${neutral}"
echo -e "${blue}─────────────────────────────────────────${neutral}"
echo -e "${yellow}  Silakan reboot VPS Anda sekarang.${neutral}"
read -p "Tekan enter untuk reboot server..."
reboot