#!/bin/bash

# ===============================
# COLOR DEFINITIONS
# ===============================
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
gray="\e[38;5;245m"
reset="\e[0m"

# ===============================
# DIRECTORY SETUP
# ===============================
# Membuat semua folder yang dibutuhkan termasuk database zivpn 
directories=(
    /etc/xray
    /etc/xray/vmess
    /etc/xray/vless
    /etc/xray/trojan
    /etc/xray/shadowsocks
    /etc/xray/ssh
    /etc/xray/zivpn
    /etc/zivpn
    /etc/zivpn/api
    /etc/zivpn/limit
    /var/www/html
)

for dir in "${directories[@]}"; do
    [ ! -d "$dir" ] && mkdir -p "$dir"
    chmod 777 "$dir"
done

# Inisialisasi Database ZiVPN agar tidak error saat apicreate dijalankan 
touch /etc/xray/zivpn/.zivpn.db
chmod 777 /etc/xray/zivpn/.zivpn.db

clear

# ===============================
# DOMAIN SETUP
# ===============================
if [ -z "$1" ]; then
    echo -e "${blue}┌─────────────────────────────────────────────────────┐${neutral}"
    echo -e "${blue}│${neutral}         >> TUNNEL AUTOMATION SYSTEM <<              ${blue}│"
    echo -e "${blue}└─────────────────────────────────────────────────────┘${neutral}"
    read -p "  Enter your domain ▶ " domain
else
    domain="$1"
fi

# Validasi IP Domain [cite: 244, 245]
vps_ip=$(curl -s ipinfo.io/ip)
domain_ip=$(getent ahosts "$domain" | awk '{print $1}' | head -n 1)

if [ "$domain_ip" != "$vps_ip" ]; then
    echo -e "${red}Domain tidak mengarah ke IP VPS${neutral}"
    exit 1
fi

# ===============================
# INSTALL DEPENDENCIES
# ===============================
echo -e "${green}Installing Golang & Dependencies...${neutral}"
apt update -y && apt install golang openssl iptables-persistent -y [cite: 230]

# ===============================
# ZIVPN SSL & ENGINE SETUP
# ===============================
echo -e "${green}Setting up ZiVPN Engine and SSL...${neutral}"

# Buat Sertifikat SSL agar Engine tidak FATAL 
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 \
-subj "/C=ID/ST=Jawa Barat/L=Bandung/O=mudziboy/OU=IT/CN=$domain" \
-keyout /etc/zivpn/zivpn.key \
-out /etc/zivpn/zivpn.crt

# Setup API Key dan Port Default 
openssl rand -hex 16 > /etc/zivpn/apikey
echo "8888" > /etc/zivpn/api_port

# Download Engine Config 
wget -q https://raw.githubusercontent.com/mudziboy/ziv/main/config.json -O /etc/zivpn/config.json

# Download Engine Binary 
wget -q https://github.com/zahidbd2/udp-zivpn/releases/download/udp-zivpn_1.4.9/udp-zivpn-linux-amd64 -O /usr/local/bin/zivpn
chmod +x /usr/local/bin/zivpn

# Daftarkan Service Engine ZiVPN
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=ZIVPN UDP VPN Server
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStart=/usr/local/bin/zivpn server -c /etc/zivpn/config.json
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# ===============================
# ZIVPN API BUILD (URUTAN FIX)
# ===============================
echo -e "${green}Building ZiVPN API on Port 8888...${neutral}"
cd /etc/zivpn/api || exit 

# Ambil file Go 
wget -q https://raw.githubusercontent.com/mudziboy/ziv/main/zivpn-api.go

# 1. Bersihkan dan Compile Dahulu 
rm -f go.mod go.sum zivpn-api 
go mod init zivpn
go mod tidy
go build -o zivpn-api zivpn-api.go
chmod +x zivpn-api

# 2. Daftarkan Service API 
cat <<EOF > /etc/systemd/system/zivpn-api.service
[Unit]
Description=ZiVPN API Service
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn/api
ExecStart=/etc/zivpn/api/zivpn-api
Restart=always
RestartSec=3

[Install]
WantedBy=multi-user.target
EOF

# Jalankan Semua Service 
systemctl daemon-reload
systemctl enable zivpn zivpn-api
systemctl restart zivpn zivpn-api

# ===============================
# IPTABLES FIX (AUTO NAT)
# ===============================
echo -e "${green}Applying Iptables UDP Forwarding...${neutral}"
iface=$(ip -4 route ls | grep default | grep -Po '(?<=dev )(\S+)' | head -1)
iptables -t nat -I PREROUTING -i $iface -p udp --dport 6000:19999 -j DNAT --to-destination :5667
netfilter-persistent save > /dev/null 2>&1

# ==========================================
# OTOMATISASI LIMIT IP ZIVPN
# ==========================================
echo -e "${green}Automating Limit IP Service...${neutral}"

# 1. Memberikan izin eksekusi otomatis 
chmod +x /usr/bin/limitipzivpn

# 2. Membuat file log agar tidak error [cite: 248]
mkdir -p /var/log/zivpn
touch /var/log/zivpn/limit.log

# 3. Membuat Service Systemd secara otomatis [cite: 149]
cat <<EOF > /etc/systemd/system/zivpn-limit.service
[Unit]
Description=ZiVPN IP Limit Daemon
After=network.target zivpn-api.service

[Service]
Type=simple
ExecStart=/usr/bin/limitipzivpn
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
EOF

# 4. Mengaktifkan Service secara otomatis [cite: 149]
systemctl daemon-reload
systemctl enable zivpn-limit
systemctl restart zivpn-limit

cd || exit
echo -e "${green}Setup ZiVPN Selesai! API Port: 8888, Engine Port: 5667${neutral}"