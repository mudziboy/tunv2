#!/bin/bash

# ===============================
# COLOR DEFINITIONS (DARI SETUP ASLI)
# ===============================
green="\e[38;5;82m"
red="\e[38;5;196m"
neutral="\e[0m"
orange="\e[38;5;130m"
blue="\e[38;5;39m"
yellow="\e[38;5;226m"
purple="\e[38;5;141m"
bold_white="\e[1;37m"
pink="\e[38;5;205m"
reset="\e[0m"
gray="\e[38;5;245m"

# ===============================
# RAINBOW FUNCTION (DARI SETUP ASLI)
# ===============================
print_rainbow() {
    local text="$1"
    local length=${#text}
    local start_color=(0 5 0)
    local mid_color=(0 200 0)
    local end_color=(0 5 0)
    for ((i = 0; i < length; i++)); do
        local progress=$((i * 100 / (length - 1)))
        if [ $progress -lt 50 ]; then
            local factor=$((progress * 2))
            r=$(((start_color[0] * (100 - factor) + mid_color[0] * factor) / 100))
            g=$(((start_color[1] * (100 - factor) + mid_color[1] * factor) / 100))
            b=$(((start_color[2] * (100 - factor) + mid_color[2] * factor) / 100))
        else
            local factor=$(((progress - 50) * 2))
            r=$(((mid_color[0] * (100 - factor) + end_color[0] * factor) / 100))
            g=$(((mid_color[1] * (100 - factor) + end_color[1] * factor) / 100))
            b=$(((mid_color[2] * (100 - factor) + end_color[2] * factor) / 100))
        fi
        printf "\e[38;2;%d;%d;%dm%s" "$r" "$g" "$b" "${text:$i:1}"
    done
    echo -e "$reset"
}

# ===============================
# PRE-INSTALLATION (DARI SETUP ASLI)
# ===============================
# Menghentikan service lama agar tidak terjadi 'Text file busy' 
systemctl stop zivpn zivpn-api zivpn-limit 2>/dev/null

# ===============================
# DIRECTORY SETUP (DARI SETUP ASLI)
# ===============================
directories=(
    /etc/xray
    /etc/xray/zivpn
    /etc/zivpn
    /etc/zivpn/api
    /etc/zivpn/limit
    /usr/bin
    /var/log/zivpn
)

for dir in "${directories[@]}"; do
    mkdir -p "$dir"
    chmod 755 "$dir"
done

touch /etc/xray/zivpn/.zivpn.db
chmod 644 /etc/xray/zivpn/.zivpn.db
clear

# ===============================
# DOMAIN SETUP (DARI SETUP ASLI)
# ===============================
if [ -z "$1" ]; then
    echo -e "${blue}┌─────────────────────────────────────────────────────┐${neutral}"
    echo -e "${blue}│${neutral}         >> TUNNEL AUTOMATION SYSTEM <<              ${blue}│${neutral}"
    echo -e "${blue}└─────────────────────────────────────────────────────┘${neutral}"
    read -p "Masukkan Domain Anda: " domain
else
    domain=$1
fi
echo "$domain" > /etc/xray/domain
echo "$domain" > /root/domain

# ===============================
# DEPENDENCIES (PERBAIKAN: TAMBAH TOOLS ZIP & LF)
# ===============================
echo -e "${green}Installing Dependencies...${neutral}"
apt update -y
apt install wget curl jq p7zip-full dos2unix tar -y

# ===============================
# EKSTRAKSI PROJECT.ZIP (PERBAIKAN: PASSWORD & IZIN)
# ===============================
if [ -f "/root/project.zip" ]; then
    echo -e "${green}Extracting Project Files with Password...${neutral}"
    # Menggunakan 7z untuk password Tunnelftdor
    7z x -pTunnelftdor /root/project.zip -o/usr/bin/ -y > /dev/null
    
    # PERBAIKAN: Ubah format Windows ke Unix untuk semua script agar bisa dieksekusi
    find /usr/bin -type f -exec dos2unix {} + 2>/dev/null
    
    # Memberikan izin eksekusi otomatis
    chmod +x /usr/bin/*
fi

# ===============================
# GOTOP INSTALLATION (PERBAIKAN: SUMBER RESMI)
# ===============================
echo -e "${green}Installing Gotop Monitor...${neutral}"
ARCH="$(uname -m)"
case "$ARCH" in
    x86_64) G_ARCH="amd64" ;;
    aarch64|arm64) G_ARCH="arm64" ;;
    *) G_ARCH="" ;;
esac

if [ -n "$G_ARCH" ]; then
    GOTOP_VER=$(curl -s "https://api.github.com/repos/xxxserafim/gotop/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    wget -q -O gotop.tgz "https://github.com/xxxserafim/gotop/releases/download/${GOTOP_VER}/gotop_${GOTOP_VER}_linux_${G_ARCH}.tgz"
    tar -xf gotop.tgz gotop
    mv gotop /usr/bin/
    chmod +x /usr/bin/gotop
    rm -f gotop.tgz
fi

# ===============================
# ZIVPN INSTALLATION (DARI SETUP ASLI)
# ===============================
echo -e "${green}Installing UDP ZiVPN Service Core...${neutral}"
if [ -f "/usr/bin/install-zivpn" ]; then
    /usr/bin/install-zivpn
fi

# ===============================
# SWAP RAM SETUP (DARI SETUP ASLI)
# ===============================
swap_file="/swapfile"
swap_size="1G"
if [ ! -f "$swap_file" ]; then
    fallocate -l $swap_size $swap_file
    chmod 600 $swap_file
    mkswap $swap_file
    swapon $swap_file
    echo "$swap_file swap swap defaults 0 0" >> /etc/fstab
    echo -e "${green}Swap RAM added: $swap_size${neutral}"
fi

# ===============================
# SERVICE ACTIVATION (DARI SETUP ASLI)
# ===============================
echo -e "${green}Starting All Services...${neutral}"
systemctl daemon-reload
services=(
    "vmess@config.service"
    "vless@config.service"
    "trojan@config.service"
    "shadowsocks@config.service"
    "haproxy.service"
    "ws.service"
    "udp.service"
    "limitip.service"
    "limitquota.service"
    "badvpn.service"
    "nginx.service"
    "ssh.service"
    "dropbear.service"
    "zivpn.service"
    "zivpn-api.service"
)

for service in "${services[@]}"; do
    systemctl enable $service >/dev/null 2>&1
    systemctl restart $service >/dev/null 2>&1
    echo -ne "Restarting $service... Done!\\n"
done

# ===============================
# CLEANUP & FINISH (DARI SETUP ASLI)
# ===============================
sudo systemctl restart netfilter-persistent
rm -f /root/setup /root/project.zip 2>/dev/null
[ -d "/root/rmck" ] && rm -rf /root/rmck

clear
print_rainbow "─────────────────────────────────────────"
print_rainbow "     INSTALASI SELESAI SEMPURNA!         "
print_rainbow "─────────────────────────────────────────"
echo -e "Ketik 'menu' untuk masuk ke dashboard."